# SPDX-License-Identifier: GPL-2.0-only
# SPDX-FileCopyrightText: 2025 TNG Technology Consulting GmbH

name: Sbom 

on:
  workflow_dispatch:
    inputs:
      test_archive:
        description: Name of the test archive to download from https://fileshare.tngtech.com/d/e69946da808b41f88047/
        required: false
        default: linux.v6.17.defconfig.tar.gz
      output_tree: 
        description: Path to the output tree relative to the src tree
        required: false
        default: kernel_build
      root_outputs_in_tree:
        description: list of paths relative to the output tree on which the sbom should be based on 
        required: false
        default: 'arch/x86/boot/bzImage modules.order'
  workflow_call:
    inputs:
      test_archive:
        required: true
        type: string
      output_tree:
        required: false
        type: string
        default: kernel_build
      root_outputs_in_tree:
        required: false
        type: string

run-name: ${{ inputs.test_archive }}

jobs:
  sbom:
    name: ${{ inputs.test_archive }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download ${{ inputs.test_archive }}
        run: |
          cd ..
          test_archive="${{ inputs.test_archive }}"
          echo "Downloading $test_archive"
          curl -L -o "$test_archive" "https://fileshare.tngtech.com/d/e69946da808b41f88047/files/?p=%2F$test_archive&dl=1"
          tar -xzf "$test_archive"

      - name: Run sbom.py
        id: run_sbom
        run: |
          python3 sbom/sbom.py \
            --src-tree ../linux \
            --output-tree ../linux/${{ inputs.output_tree }} \
            --root-outputs-in-tree ${{ inputs.root_outputs_in_tree }} \
            --spdx sbom.spdx.json \
            --used-files sbom.used_files.txt
          
          test_archive="${{ inputs.test_archive }}"
          output_dir="${test_archive%.tar.gz}"
          echo "output_dir=$output_dir" >> $GITHUB_OUTPUT
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-outputs-${{ steps.run_sbom.outputs.output_dir }}
          path: |
            sbom.spdx.json
            sbom.used_files.txt
          retention-days: 30
