<!--
SPDX-License-Identifier: GPL-2.0-only
SPDX-License-Identifier: MIT
SPDX-FileCopyrightText: 2025 TNG Technology Consulting GmbH
SPDX-FileCopyrightText: (C) 2018 Vasco Asturiano
-->

<head>
    <style>
        body {
            margin: 0;
        }
    </style>

    <script src="//cdn.jsdelivr.net/npm/force-graph"></script>
    <script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>
</head>

<body>
    <div id="graph"></div>

    <script>
        window.devicePixelRatio = 1; // use standard resolution in retina displays

        function initializeGraph(data) {
            console.log("Loaded", data)
            const formatNodeLabel = node => {
                return `${node.depth}: ${node.id}`;
            };

            const colorScale = node => {
                if (node.id.endsWith("built-in.a")) {
                    return '#000000';   // Black
                }
                if (node.id.endsWith(".o")) {
                    return '#66cc33' // Green
                }
                if (node.id.endsWith(".c") || node.id.endsWith(".S") || node.id.endsWith(".rs")) {
                    return '#3399ff';   // Blue
                }
                switch (node.depth) {
                    case 0: return '#ff0000';   // Red
                    case 1: return '#ff7f00';   // Orange
                    case 2: return '#ffbf00';   // Golden Yellow
                    case 3: return '#9966cc';   // Purple
                    default: return '#d9d9d9';  // Light Gray (fallback)
                }
            };

            const size = node => 5 + 10 * Math.exp(-0.5 * node.depth);

            const graph = ForceGraph()(document.getElementById('graph'))
                .graphData(data)
                .d3AlphaDecay(0.02)
                .d3VelocityDecay(0.08)
                .linkColor(() => 'rgba(0,0,0,0.5)')
                .linkWidth(1)
                .linkDirectionalArrowLength(6)
                .zoom(0.2)
                .enablePointerInteraction(true)
                .nodeLabel(node => formatNodeLabel(node))
                .nodeCanvasObject((node, ctx, globalScale) => {
                    const radius = size(node);
                    ctx.beginPath();
                    ctx.arc(node.x, node.y, radius, 0, 2 * Math.PI, false);
                    ctx.fillStyle = colorScale(node);
                    ctx.fill();
                })
                .nodePointerAreaPaint((node, color, ctx) => {
                    const radius = size(node);
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.arc(node.x, node.y, radius, 0, 2 * Math.PI, false);
                    ctx.fill();
                });
        }

        fetch('./cmd_graph.json')
            .then(res => {
                if (!res.ok) throw new Error('Uncompressed file not found');
                return res.json();
            })
            .then(initializeGraph)
            .catch(() => {
                fetch('./cmd_graph.json.gz')
                    .then(res => res.arrayBuffer())
                    .then(buffer => {
                        const decompressed = pako.inflate(new Uint8Array(buffer), { to: 'string' });
                        initializeGraph(JSON.parse(decompressed));
                    });
            });
    </script>
</body>
